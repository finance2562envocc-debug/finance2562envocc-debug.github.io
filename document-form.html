<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>เพิ่ม/แก้ไขเอกสาร</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="./theme-legacy.css?v=20260221-17">
  <style>
    .form-page {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
    }

    .form-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .back-btn {
      border: 1px solid var(--input-border);
      background: var(--card-bg);
      color: var(--text-color);
      min-height: 40px;
      border-radius: 999px;
      font-weight: 760;
      padding: 0 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .back-btn:hover {
      transform: translateY(-1px);
      border-color: rgba(10, 132, 255, 0.45);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.15);
    }

    .page-doc-form .main-card {
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.34) !important;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.76), rgba(246, 251, 255, 0.62)) !important;
      box-shadow: 0 30px 56px rgba(15, 23, 42, 0.14), inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
    }

    .header-bg {
      background: linear-gradient(145deg, #66baff 0%, #3196fb 42%, #1f79f0 100%);
      color: #fff;
      text-align: center;
      padding: 24px 16px 26px;
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid rgba(255, 255, 255, 0.28);
    }

    .header-bg::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0));
      pointer-events: none;
    }

    .header-bg::after {
      content: "";
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 999px;
      right: -78px;
      top: -92px;
      background: rgba(255, 255, 255, 0.18);
      pointer-events: none;
    }

    .header-bg i {
      font-size: 2.1rem;
      margin-bottom: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.58);
      background: rgba(255, 255, 255, 0.1);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .header-bg h3 {
      margin: 0;
      font-size: 2rem;
      line-height: 1.08;
      font-weight: 830;
      letter-spacing: 0;
      color: rgba(255, 255, 255, 0.98);
      text-shadow: 0 1px 0 rgba(0, 0, 0, 0.08);
    }

    .header-bg small {
      display: block;
      margin-top: 8px;
      font-weight: 610;
      font-size: 1.04rem;
      letter-spacing: 0.002em;
      color: rgba(242, 248, 255, 0.96) !important;
      text-shadow: 0 1px 0 rgba(0, 0, 0, 0.08);
    }

    .card-body {
      padding: 16px;
      display: grid;
      gap: 12px;
      background: linear-gradient(180deg, rgba(235, 245, 255, 0.32), rgba(235, 245, 255, 0.16));
    }

    .form-section {
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.84), rgba(250, 253, 255, 0.7));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.82), 0 12px 26px rgba(15, 23, 42, 0.06);
    }

    .form-section-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.94rem;
      font-weight: 860;
      color: var(--text-color);
      margin-bottom: 10px;
    }

    .row {
      display: grid;
      gap: 10px;
    }

    .row.two {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .form-label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.8rem;
      font-weight: 760;
      color: var(--text-muted);
    }

    .page-doc-form .form-control,
    .page-doc-form .form-select {
      width: 100%;
      height: 52px;
      min-height: 52px;
      border-radius: 16px !important;
      border: 1px solid rgba(148, 163, 184, 0.34) !important;
      background-color: #ffffff !important;
      background-image: none;
      color: var(--text-color);
      font: inherit;
      font-size: 1rem;
      line-height: 1.2;
      padding: 0 16px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      font-weight: 600;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.88);
    }

    .page-doc-form .form-select {
      padding-right: 42px !important;
      background-image: var(--dd-arrow-light) !important;
      background-repeat: no-repeat !important;
      background-position: right 14px center !important;
      background-size: 14px 14px !important;
    }

    .page-doc-form input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .page-doc-form input[type="number"]::-webkit-outer-spin-button,
    .page-doc-form input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .page-doc-form textarea.form-control {
      height: auto;
      min-height: 104px;
      padding: 12px 16px;
      resize: vertical;
    }

    .form-control:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--primary-color-soft);
    }

    .form-control[disabled],
    .form-select[disabled] {
      opacity: 0.88;
      cursor: not-allowed;
    }

    .text-danger {
      color: #dc2626;
    }

    .thai-date-input .form-control {
      display: flex;
      align-items: center;
      min-height: 52px;
      height: 52px;
      padding-right: 44px !important;
      padding-left: 16px !important;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .thai-time-wrap {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr) auto;
      align-items: center;
      gap: 7px;
    }

    .thai-time-wrap .form-select {
      min-height: 52px;
      height: 52px;
    }

    .thai-time-sep,
    .thai-time-label {
      font-weight: 760;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .inline-note {
      margin: 0 0 10px;
      color: var(--text-muted);
      font-size: 0.78rem;
      font-weight: 600;
      line-height: 1.45;
    }

    body.dark-mode .page-doc-form .main-card {
      border-color: rgba(148, 163, 184, 0.4) !important;
      background: linear-gradient(180deg, rgba(16, 26, 40, 0.78), rgba(12, 20, 32, 0.68)) !important;
      box-shadow: 0 34px 64px rgba(2, 8, 20, 0.56), inset 0 1px 0 rgba(255, 255, 255, 0.06) !important;
    }

    body.dark-mode .page-doc-form .card-body {
      background: linear-gradient(180deg, rgba(16, 26, 40, 0.28), rgba(16, 26, 40, 0.14));
    }

    body.dark-mode .page-doc-form .form-section {
      border-color: rgba(148, 163, 184, 0.32);
      background: linear-gradient(180deg, rgba(19, 30, 45, 0.82), rgba(15, 24, 36, 0.7));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06), 0 16px 34px rgba(2, 8, 20, 0.34);
    }

    body.dark-mode .page-doc-form .form-control,
    body.dark-mode .page-doc-form .form-select {
      border-color: rgba(148, 163, 184, 0.38) !important;
      background-color: rgba(15, 24, 36, 0.86) !important;
      background-image: none;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    body.dark-mode .page-doc-form .form-select {
      background-image: var(--dd-arrow-dark) !important;
      background-repeat: no-repeat !important;
      background-position: right 14px center !important;
      background-size: 14px 14px !important;
    }

    #planFieldsWrap {
      display: block;
    }

    .submit-btn {
      border: none;
      width: 100%;
      min-height: 48px;
      border-radius: 999px;
      font: inherit;
      font-weight: 860;
      color: #fff;
      background: linear-gradient(180deg, #2f97ff 0%, #0a84ff 62%, #0071e3 100%);
      cursor: pointer;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s ease, box-shadow 0.25s ease;
      box-shadow: 0 16px 34px rgba(10, 132, 255, 0.26);
    }

    .submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 42px rgba(10, 132, 255, 0.32);
    }

    .submit-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .error-box {
      display: none;
      border: 1px solid rgba(239, 68, 68, 0.36);
      background: rgba(239, 68, 68, 0.12);
      color: #991b1b;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 650;
      font-size: 0.88rem;
      line-height: 1.45;
    }

    .error-box.show {
      display: block;
    }

    .saving-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 3500;
      background: rgba(15, 23, 42, 0.2);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .saving-card {
      min-width: min(86vw, 320px);
      border-radius: 20px;
      padding: 18px 18px 16px;
      text-align: center;
      background: var(--card-strong);
      border: 1px solid var(--input-border);
      box-shadow: 0 24px 54px rgba(15, 23, 42, 0.24);
    }

    .saving-spinner {
      width: 42px;
      height: 42px;
      margin: 0 auto 12px;
      border-radius: 50%;
      border: 3px solid rgba(10, 132, 255, 0.22);
      border-top-color: var(--primary-color);
      animation: spin 0.72s linear infinite;
    }

    .saving-title {
      font-size: 1rem;
      font-weight: 820;
      color: var(--text-color);
      margin-bottom: 4px;
    }

    .saving-sub {
      font-size: 0.84rem;
      color: var(--text-muted);
      font-weight: 620;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 900px) {
      .row.two {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 760px) {
      .form-page {
        padding: 12px;
      }

      .form-top {
        margin-bottom: 10px;
      }

      .back-btn {
        width: 100%;
        justify-content: center;
      }

      .header-bg {
        padding: 16px 12px;
      }

      .header-bg i {
        width: 50px;
        height: 50px;
        font-size: 1.7rem;
      }

      .header-bg h3 {
        font-size: 1.5rem;
      }

      .card-body {
        padding: 12px;
        gap: 10px;
      }

      .form-section {
        padding: 11px;
        border-radius: 14px;
      }

      .thai-time-wrap {
        grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
      }

      .thai-time-label {
        grid-column: 1 / -1;
      }

      .page-doc-form .form-control,
      .page-doc-form .form-select {
        height: 50px;
        min-height: 50px;
        font-size: 16px;
      }

      .thai-date-input .form-control,
      .thai-time-wrap .form-select {
        height: 50px;
        min-height: 50px;
      }

      .page-doc-form textarea.form-control {
        min-height: 98px;
      }
    }

    @media (max-width: 520px) {
      .form-page {
        padding: 8px;
      }

      .header-bg {
        padding: 14px 10px;
      }

      .header-bg small {
        font-size: 0.94rem;
      }

      .card-body {
        padding: 10px;
      }

      .submit-btn {
        min-height: 46px;
      }
    }
  </style>
</head>
<body class="page-doc-form">
  <div class="form-page">
    <div class="form-top">
      <button id="btnBack" type="button" class="back-btn"><i class="bi bi-arrow-left"></i> กลับ</button>
    </div>

    <div id="errBox" class="error-box"></div>

    <div class="main-card" id="mainCard" style="display:none;">
      <div class="header-bg">
        <i id="pageIcon" class="bi bi-plus-circle"></i>
        <h3 id="pageTitle">เพิ่มเอกสารใหม่</h3>
        <small id="pageSub">กำลังโหลดข้อมูล...</small>
      </div>

      <div class="card-body">
        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-file-earmark-text"></i>ข้อมูลพื้นฐาน</div>

          <div id="fiscalRow" class="row two" style="margin-bottom:10px;">
            <div>
              <label class="form-label">ปีงบประมาณ <span class="text-danger">*</span></label>
              <select id="fiscalYear" class="form-select"></select>
            </div>
            <div>
              <label class="form-label">เลขที่รับ (อัตโนมัติ)</label>
              <input id="receiveNoDisplay" class="form-control" type="text" disabled placeholder="เลือกปีงบประมาณ">
            </div>
          </div>

          <div id="receiveNoReadOnlyRow" style="display:none;margin-bottom:10px;">
            <label class="form-label">เลขที่รับ</label>
            <input id="receiveNoReadOnly" class="form-control" type="text" disabled>
          </div>

          <div class="row two">
            <div>
              <label class="form-label">วันที่รับเอกสาร <span class="text-danger">*</span></label>
              <div class="thai-date-input" onclick="openCalendar('dateRec')">
                <input type="hidden" id="dateRec" value="">
                <div id="dateRecDisplay" class="form-control" style="color:var(--text-muted)">เลือกวันที่...</div>
                <i class="bi bi-calendar3 cal-icon"></i>
              </div>
            </div>
            <div>
              <label class="form-label">เวลาที่รับ <span class="text-danger">*</span></label>
              <div class="thai-time-wrap">
                <select id="timeRecHr" class="form-select"></select>
                <span class="thai-time-sep">:</span>
                <select id="timeRecMn" class="form-select"></select>
                <span class="thai-time-label">น.</span>
              </div>
            </div>
          </div>
        </section>

        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-card-text"></i>ข้อมูลเอกสาร</div>

          <div class="row two" style="margin-bottom:10px;">
            <div>
              <label class="form-label">เลขที่ สธ. (กลุ่มงาน) <span class="text-danger">*</span></label>
              <input type="text" id="docNoSdh" class="form-control" placeholder="เลขที่ สธ. (กลุ่มงาน)">
            </div>
            <div>
              <label class="form-label">ลงวันที่ กอง/กลุ่ม <span class="text-danger">*</span></label>
              <div class="thai-date-input" onclick="openCalendar('dated')">
                <input type="hidden" id="dated" value="">
                <div id="datedDisplay" class="form-control" style="color:var(--text-muted)">เลือกวันที่...</div>
                <i class="bi bi-calendar3 cal-icon"></i>
              </div>
            </div>
          </div>

          <div style="margin-bottom:10px;">
            <label class="form-label">กลุ่ม/ศูนย์ <span class="text-danger">*</span></label>
            <select id="group" class="form-select"></select>
          </div>

          <div style="margin-bottom:10px;">
            <label class="form-label">ชื่อผู้ส่ง/ผู้ยืม/ผู้ใช้หนี้/ผู้ประสานงาน <span class="text-danger">*</span></label>
            <input type="text" id="sender" class="form-control" placeholder="ชื่อผู้ส่ง/ผู้ยืม/ผู้ใช้หนี้/ผู้ประสานงาน">
          </div>

          <div>
            <label class="form-label">วัตถุประสงค์ <span class="text-danger">*</span></label>
            <select id="purpose" class="form-select"></select>
          </div>
        </section>

        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-chat-left-text"></i>รายละเอียดเรื่อง</div>
          <p class="inline-note">ข้อความจาก 4 ช่องจะนำมาต่อกัน (เว้นวรรค) เป็นหัวเรื่องเอกสาร</p>

          <div style="margin-bottom:8px;">
            <label class="form-label">เรื่อง (L) <span class="text-danger">*</span></label>
            <input type="text" id="subjectK" class="form-control" placeholder="เรื่อง">
          </div>
          <div style="margin-bottom:8px;">
            <label class="form-label">วันที่/เดือน/ปี (M)</label>
            <input type="text" id="subjectL" class="form-control" placeholder="วันที่/เดือน/ปี">
          </div>
          <div style="margin-bottom:8px;">
            <label class="form-label">เวลา (N)</label>
            <input type="text" id="subjectM" class="form-control" placeholder="เวลา">
          </div>
          <div>
            <label class="form-label">สถานที่ (O)</label>
            <input type="text" id="subjectN" class="form-control" placeholder="สถานที่">
          </div>
        </section>

        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-cash-stack"></i>จำนวนเงิน</div>
          <div class="row two">
            <div>
              <label class="form-label">จำนวนเบิก/ยืม/คืน <span class="text-danger">*</span></label>
              <input type="number" id="amount" class="form-control" step="0.01" placeholder="0.00">
            </div>
            <div>
              <label class="form-label">ส่วนต่าง/เงินเหลือคืน <span class="text-danger">*</span></label>
              <input type="number" id="difference" class="form-control" step="0.01" placeholder="0.00">
            </div>
          </div>
        </section>

        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-wallet2"></i>ประเภทเงินงบประมาณ</div>
          <div style="margin-bottom:10px;">
            <label class="form-label">ประเภทเงินงบประมาณ <span class="text-danger">*</span></label>
            <select id="budgetType" class="form-select"></select>
          </div>

          <div id="planFieldsWrap">
            <div style="margin-bottom:8px;">
              <label class="form-label">ผลผลิต (R) <span class="text-danger plan-required">*</span></label>
              <input type="text" id="prod" class="form-control">
            </div>
            <div style="margin-bottom:8px;">
              <label class="form-label">กิจกรรมหลัก (S) <span class="text-danger plan-required">*</span></label>
              <input type="text" id="mainAct" class="form-control">
            </div>
            <div style="margin-bottom:8px;">
              <label class="form-label">โครงการย่อย (T) <span class="text-danger plan-required">*</span></label>
              <input type="text" id="subProject" class="form-control">
            </div>
            <div>
              <label class="form-label">กิจกรรมย่อย (U) <span class="text-danger plan-required">*</span></label>
              <input type="text" id="activity" class="form-control">
            </div>
          </div>
        </section>

        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-bookmark-star"></i>เลขที่หนังสือส่งกองคลัง</div>
          <p class="inline-note"><i class="bi bi-info-circle me-1"></i>สามารถกรอกหรือเว้นไว้ก็ได้ เพื่อกรอกเพิ่มเติมในภายหลัง</p>

          <div class="row two">
            <div>
              <label class="form-label">เลขที่หนังสือ (AK)</label>
              <input type="text" id="amDocNo" class="form-control" placeholder="เลขที่หนังสือ">
            </div>
            <div>
              <label class="form-label">ลงวันที่ดำเนินการ (AL)</label>
              <div class="thai-date-input" onclick="openCalendar('anDate')">
                <input type="hidden" id="anDate" value="">
                <div id="anDateDisplay" class="form-control" style="color:var(--text-muted)">เลือกวันที่...</div>
                <i class="bi bi-calendar3 cal-icon"></i>
              </div>
            </div>
          </div>
        </section>

        <section class="form-section">
          <div class="form-section-title"><i class="bi bi-chat-left-text"></i>หมายเหตุ</div>
          <label class="form-label">หมายเหตุ (AM)</label>
          <textarea id="statusRemark" class="form-control" rows="3" placeholder="หมายเหตุเพิ่มเติม (ไม่บังคับ)"></textarea>
        </section>

        <button id="btnSubmit" type="button" class="submit-btn"><i class="bi bi-save-fill"></i><span id="btnSubmitText">เพิ่มเอกสาร</span></button>
      </div>
    </div>
  </div>

  <div id="loadingMsg" class="saving-overlay">
    <div class="saving-card">
      <div class="saving-spinner"></div>
      <div class="saving-title">กำลังบันทึกข้อมูล</div>
      <div class="saving-sub">โปรดรอสักครู่...</div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./api-client.js?v=20260221-6"></script>
  <script src="./theme-legacy.js?v=20260221-3"></script>
  <script src="./app-common.js?v=20260221-2"></script>
  <script>
    (function () {
      'use strict';

      var C = window.DocFrontendCommon;
      var q = C.parseQuery();
      var isEdit = C.safeTrim(q.mode || '').toLowerCase() === 'edit';
      var editId = C.safeTrim(q.id || '');
      var copyFromId = C.safeTrim(q.copyFrom || '');
      var isCopy = !isEdit && !!copyFromId;
      var APP_BROWSER_NAME = 'ระบบทะเบียนคุมเอกสาร';

      var state = {
        settings: null,
        api: null,
        user: null,
        options: null,
        nextNos: {},
        doc: null,
        copyDoc: null
      };

      var els = {
        mainCard: document.getElementById('mainCard'),
        errBox: document.getElementById('errBox'),
        btnBack: document.getElementById('btnBack'),
        pageIcon: document.getElementById('pageIcon'),
        pageTitle: document.getElementById('pageTitle'),
        pageSub: document.getElementById('pageSub'),
        fiscalRow: document.getElementById('fiscalRow'),
        receiveNoReadOnlyRow: document.getElementById('receiveNoReadOnlyRow'),
        receiveNoReadOnly: document.getElementById('receiveNoReadOnly'),
        fiscalYear: document.getElementById('fiscalYear'),
        receiveNoDisplay: document.getElementById('receiveNoDisplay'),
        dateRec: document.getElementById('dateRec'),
        timeRecHr: document.getElementById('timeRecHr'),
        timeRecMn: document.getElementById('timeRecMn'),
        docNoSdh: document.getElementById('docNoSdh'),
        dated: document.getElementById('dated'),
        group: document.getElementById('group'),
        sender: document.getElementById('sender'),
        purpose: document.getElementById('purpose'),
        subjectK: document.getElementById('subjectK'),
        subjectL: document.getElementById('subjectL'),
        subjectM: document.getElementById('subjectM'),
        subjectN: document.getElementById('subjectN'),
        amount: document.getElementById('amount'),
        difference: document.getElementById('difference'),
        budgetType: document.getElementById('budgetType'),
        prod: document.getElementById('prod'),
        mainAct: document.getElementById('mainAct'),
        subProject: document.getElementById('subProject'),
        activity: document.getElementById('activity'),
        planFieldsWrap: document.getElementById('planFieldsWrap'),
        amDocNo: document.getElementById('amDocNo'),
        anDate: document.getElementById('anDate'),
        statusRemark: document.getElementById('statusRemark'),
        btnSubmit: document.getElementById('btnSubmit'),
        btnSubmitText: document.getElementById('btnSubmitText'),
        loadingMsg: document.getElementById('loadingMsg')
      };

      function showError(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) {
          els.errBox.classList.remove('show');
          els.errBox.textContent = '';
          return;
        }
        els.errBox.textContent = msg;
        els.errBox.classList.add('show');
      }

      function updateBrowserTitle(idValue) {
        var id = C.safeTrim(idValue || '');
        var page = '';
        if (isEdit) {
          page = id ? ('แก้ไขเอกสาร • ' + id) : 'แก้ไขเอกสาร';
        } else if (isCopy) {
          page = id ? ('เพิ่มเอกสารจากสำเนา • ' + id) : 'เพิ่มเอกสารจากสำเนา';
        } else {
          page = 'เพิ่มเอกสารใหม่';
        }
        document.title = page + ' | ' + APP_BROWSER_NAME;
      }

      function setSaving(isSaving) {
        var active = !!isSaving;
        els.btnSubmit.disabled = active;
        els.loadingMsg.style.display = active ? 'flex' : 'none';
        els.loadingMsg.setAttribute('aria-hidden', active ? 'false' : 'true');
      }

      function fillTimeOptions() {
        var h = '<option value="">--</option>';
        var m = '<option value="">--</option>';
        for (var i = 0; i < 24; i++) {
          var hv = String(i).padStart(2, '0');
          h += '<option value="' + hv + '">' + hv + '</option>';
        }
        for (var j = 0; j < 60; j++) {
          var mv = String(j).padStart(2, '0');
          m += '<option value="' + mv + '">' + mv + '</option>';
        }
        els.timeRecHr.innerHTML = h;
        els.timeRecMn.innerHTML = m;
      }

      function refreshDateDisplays() {
        if (typeof window.updDD === 'function') {
          window.updDD('dateRec');
          window.updDD('dated');
          window.updDD('anDate');
        }
      }

      function updateReceiveNo() {
        if (isEdit) return;
        var fy = C.safeTrim(els.fiscalYear.value || '');
        els.receiveNoDisplay.value = state.nextNos[fy] || '';
      }

      function togglePlanFields() {
        var budgetType = C.safeTrim(els.budgetType.value || '');
        var usePlan = budgetType === 'เงินงบประมาณ';
        els.planFieldsWrap.style.display = usePlan ? 'block' : 'none';

        var requiredMarks = document.querySelectorAll('.plan-required');
        for (var i = 0; i < requiredMarks.length; i++) {
          requiredMarks[i].style.display = usePlan ? 'inline' : 'none';
        }

        if (!usePlan) {
          els.prod.value = '';
          els.mainAct.value = '';
          els.subProject.value = '';
          els.activity.value = '';
        }
      }

      function fillOptions() {
        var info = (state.options && state.options.data) ? state.options.data : { fiscalYears: [], groups: [], purposes: [] };
        var fiscalYears = Array.isArray(info.fiscalYears) ? info.fiscalYears : [];
        var groups = Array.isArray(info.groups) ? info.groups : [];
        var purposes = Array.isArray(info.purposes) ? info.purposes : [];

        var fiscalHtml = '<option value="" selected disabled>เลือกปีงบประมาณ...</option>';
        for (var i = 0; i < fiscalYears.length; i++) {
          fiscalHtml += '<option value="' + C.escapeHtml(fiscalYears[i]) + '">' + C.escapeHtml(fiscalYears[i]) + '</option>';
        }
        els.fiscalYear.innerHTML = fiscalHtml;

        var groupHtml = '<option value="">เลือกกลุ่ม/ศูนย์...</option>';
        for (var g = 0; g < groups.length; g++) {
          groupHtml += '<option value="' + C.escapeHtml(groups[g]) + '">' + C.escapeHtml(groups[g]) + '</option>';
        }
        els.group.innerHTML = groupHtml;

        var purposeHtml = '<option value="">เลือกวัตถุประสงค์...</option>';
        for (var p = 0; p < purposes.length; p++) {
          purposeHtml += '<option value="' + C.escapeHtml(purposes[p]) + '">' + C.escapeHtml(purposes[p]) + '</option>';
        }
        els.purpose.innerHTML = purposeHtml;

        var budgetTypes = ['กองทุน ววน.', 'กองทุนเงินทดแทน', 'เงินบำรุง', 'เงินงบประมาณ'];
        var budgetHtml = '<option value="" selected disabled>เลือกประเภทเงินงบประมาณ...</option>';
        for (var b = 0; b < budgetTypes.length; b++) {
          budgetHtml += '<option value="' + C.escapeHtml(budgetTypes[b]) + '">' + C.escapeHtml(budgetTypes[b]) + '</option>';
        }
        els.budgetType.innerHTML = budgetHtml;
      }

      function ensureSelectOption(selectEl, value) {
        if (!selectEl) return;
        var next = C.safeTrim(value || '');
        if (!next) return;
        var found = false;
        var options = selectEl.options || [];
        for (var i = 0; i < options.length; i++) {
          if (C.safeTrim(options[i].value || '') === next) {
            found = true;
            break;
          }
        }
        if (!found) {
          var opt = document.createElement('option');
          opt.value = next;
          opt.textContent = next;
          selectEl.appendChild(opt);
        }
        selectEl.value = next;
      }

      function pickDocValue(doc, keys) {
        if (!doc || !Array.isArray(keys)) return '';
        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          if (!Object.prototype.hasOwnProperty.call(doc, key)) continue;
          var value = doc[key];
          if (value === null || typeof value === 'undefined') continue;
          if (String(value).trim() === '') continue;
          return value;
        }
        return '';
      }

      function normalizeNumberInputValue(value) {
        var raw = String(value == null ? '' : value).trim();
        if (!raw) return '';

        var thaiDigits = '๐๑๒๓๔๕๖๗๘๙';
        raw = raw.replace(/[๐-๙]/g, function (ch) {
          var idx = thaiDigits.indexOf(ch);
          return idx >= 0 ? String(idx) : ch;
        });

        raw = raw.replace(/−/g, '-').replace(/\s+/g, '');
        raw = raw.replace(/[^0-9,.\-]/g, '');

        if (raw.indexOf('.') === -1 && raw.indexOf(',') !== -1) {
          raw = raw.replace(',', '.');
        } else {
          raw = raw.replace(/,/g, '');
        }

        var sign = '';
        if (raw.charAt(0) === '-') {
          sign = '-';
          raw = raw.slice(1);
        }
        raw = raw.replace(/\-/g, '');

        var parts = raw.split('.');
        if (parts.length > 2) {
          raw = parts[0] + '.' + parts.slice(1).join('');
        }
        if (raw.charAt(0) === '.') raw = '0' + raw;
        raw = sign + raw;

        var num = Number(raw);
        if (!isFinite(num)) return '';
        return String(num);
      }

      function setFormData(doc) {
        if (!doc) return;
        updateBrowserTitle(doc.docId || editId);

        els.receiveNoReadOnly.value = doc.receiveNo || '';
        els.receiveNoDisplay.value = doc.receiveNo || '';

        els.dateRec.value = doc.dateRecInput || '';
        els.dated.value = doc.datedInput || '';
        els.anDate.value = doc.anDateInput || '';

        var timeRec = C.safeTrim(doc.timeRec || '');
        var sep = timeRec.indexOf('.') >= 0 ? '.' : ':';
        var tp = timeRec ? timeRec.split(sep) : [];
        if (tp.length >= 2) {
          els.timeRecHr.value = String(parseInt(tp[0], 10)).padStart(2, '0');
          els.timeRecMn.value = String(parseInt(tp[1], 10)).padStart(2, '0');
        }

        els.docNoSdh.value = doc.docNoSdh || '';
        ensureSelectOption(els.group, doc.group || '');
        els.sender.value = doc.sender || '';
        ensureSelectOption(els.purpose, doc.purpose || '');
        els.subjectK.value = doc.subjectK || '';
        els.subjectL.value = doc.subjectL || '';
        els.subjectM.value = doc.subjectM || '';
        els.subjectN.value = doc.subjectN || '';
        els.amount.value = normalizeNumberInputValue(
          pickDocValue(doc, ['amount', 'amountDisplay', 'amountText', 'amt', 'totalAmount'])
        );
        els.difference.value = normalizeNumberInputValue(
          pickDocValue(doc, ['difference', 'differenceDisplay', 'differenceText', 'diff', 'balanceDifference'])
        );
        ensureSelectOption(els.budgetType, doc.budgetType || '');
        els.prod.value = doc.prod || '';
        els.mainAct.value = doc.mainAct || '';
        els.subProject.value = doc.subProject || '';
        els.activity.value = doc.activity || '';
        els.amDocNo.value = doc.amDocNo || '';
        els.statusRemark.value = doc.statusRemark || '';

        togglePlanFields();
        refreshDateDisplays();
      }

      function setCopyFormData(doc) {
        if (!doc) return;
        updateBrowserTitle(doc.docId || copyFromId);

        // คัดลอกเฉพาะส่วน: ข้อมูลเอกสาร, รายละเอียดเรื่อง, ประเภทเงินงบประมาณ
        els.docNoSdh.value = C.safeText(doc.docNoSdh || '');
        els.dated.value = C.safeTrim(pickDocValue(doc, ['datedInput', 'dated']) || '');
        ensureSelectOption(els.group, doc.group || '');
        els.sender.value = C.safeText(doc.sender || '');
        ensureSelectOption(els.purpose, doc.purpose || '');

        els.subjectK.value = C.safeText(doc.subjectK || doc.subject || '');
        els.subjectL.value = C.safeText(doc.subjectL || '');
        els.subjectM.value = C.safeText(doc.subjectM || '');
        els.subjectN.value = C.safeText(doc.subjectN || '');

        ensureSelectOption(els.budgetType, doc.budgetType || '');
        els.prod.value = C.safeText(doc.prod || '');
        els.mainAct.value = C.safeText(doc.mainAct || '');
        els.subProject.value = C.safeText(doc.subProject || '');
        els.activity.value = C.safeText(doc.activity || '');

        togglePlanFields();
        refreshDateDisplays();
      }

      function buildFormData() {
        var hh = C.safeTrim(els.timeRecHr.value || '');
        var mm = C.safeTrim(els.timeRecMn.value || '');
        var timeRec = hh && mm ? (hh + '.' + mm) : '';
        var frontendDocumentUrl = '';
        try {
          frontendDocumentUrl = new URL('document-view.html', window.location.href).toString();
        } catch (_ignore) {}

        return {
          frontendBaseUrl: C.safeTrim(frontendDocumentUrl || ''),
          fiscalYear: isEdit ? '' : C.safeTrim(els.fiscalYear.value || ''),
          dateRec: C.safeTrim(els.dateRec.value || ''),
          timeRec: timeRec,
          docNoSdh: C.safeTrim(els.docNoSdh.value || ''),
          dated: C.safeTrim(els.dated.value || ''),
          group: C.safeTrim(els.group.value || ''),
          sender: C.safeTrim(els.sender.value || ''),
          purpose: C.safeTrim(els.purpose.value || ''),
          budgetType: C.safeTrim(els.budgetType.value || ''),
          subjectK: C.safeTrim(els.subjectK.value || ''),
          subjectL: C.safeTrim(els.subjectL.value || ''),
          subjectM: C.safeTrim(els.subjectM.value || ''),
          subjectN: C.safeTrim(els.subjectN.value || ''),
          amount: normalizeNumberInputValue(els.amount.value || ''),
          difference: normalizeNumberInputValue(els.difference.value || ''),
          prod: C.safeTrim(els.prod.value || ''),
          mainAct: C.safeTrim(els.mainAct.value || ''),
          subProject: C.safeTrim(els.subProject.value || ''),
          activity: C.safeTrim(els.activity.value || ''),
          amDocNo: C.safeTrim(els.amDocNo.value || ''),
          anDate: C.safeTrim(els.anDate.value || ''),
          statusRemark: C.safeTrim(els.statusRemark.value || '')
        };
      }

      function validateForm(formData) {
        if (!isEdit) {
          if (!formData.fiscalYear) return 'กรุณาเลือกปีงบประมาณ';
          if (!formData.group) return 'กรุณาเลือกกลุ่ม/ศูนย์';
          if (!formData.dateRec) return 'กรุณาเลือกวันที่รับเอกสาร';
          if (!formData.timeRec) return 'กรุณากรอกเวลาที่รับเอกสาร (ชั่วโมงและนาที)';
          if (!formData.dated) return 'กรุณาเลือกลงวันที่ของกอง/กลุ่ม';
        }

        if (!formData.subjectK) return 'กรุณากรอกเรื่อง (ช่อง L)';
        if (!formData.docNoSdh) return 'กรุณากรอกเลขที่ สธ. (กลุ่มงาน)';
        if (!formData.sender) return 'กรุณากรอกชื่อผู้ส่ง/ผู้ยืม/ผู้ใช้หนี้/ผู้ประสานงาน';
        if (!formData.purpose) return 'กรุณาเลือกวัตถุประสงค์';
        if (!formData.budgetType) return 'กรุณาเลือกประเภทเงินงบประมาณ';

        if (!formData.amount || isNaN(parseFloat(formData.amount))) {
          return 'กรุณากรอกจำนวนเบิก/ยืม/คืน (ตัวเลข)';
        }
        if (!formData.difference || isNaN(parseFloat(formData.difference))) {
          return 'กรุณากรอกส่วนต่าง/เงินเหลือคืน (ตัวเลข)';
        }

        var needPlan = formData.budgetType === 'เงินงบประมาณ';
        if (needPlan) {
          if (!formData.prod) return 'กรุณากรอกผลผลิต';
          if (!formData.mainAct) return 'กรุณากรอกกิจกรรมหลัก';
          if (!formData.subProject) return 'กรุณากรอกโครงการย่อย';
          if (!formData.activity) return 'กรุณากรอกกิจกรรมย่อย';
        } else {
          formData.prod = '';
          formData.mainAct = '';
          formData.subProject = '';
          formData.activity = '';
        }

        return '';
      }

      function withTimeout(promise, timeoutMs, timeoutMessage) {
        var ms = Number(timeoutMs);
        if (!isFinite(ms) || ms <= 0) ms = 45000;
        return new Promise(function (resolve, reject) {
          var done = false;
          var timer = setTimeout(function () {
            if (done) return;
            done = true;
            reject(new Error(timeoutMessage || 'การเชื่อมต่อใช้เวลานานเกินไป กรุณาลองใหม่'));
          }, ms);

          Promise.resolve(promise).then(function (value) {
            if (done) return;
            done = true;
            clearTimeout(timer);
            resolve(value);
          }).catch(function (err) {
            if (done) return;
            done = true;
            clearTimeout(timer);
            reject(err);
          });
        });
      }

      function humanizeSaveErrorMessage(message) {
        var msg = C.safeTrim(message || '');
        if (!msg) return 'บันทึกไม่สำเร็จ';
        if (msg.indexOf('เลขที่เอกสารซ้ำ') !== -1) {
          return msg + '\nกรุณาแก้ไขช่อง "เลขที่ สธ. (กลุ่มงาน)" แล้วบันทึกใหม่';
        }
        if (msg.indexOf('เลขที่หนังสือส่งกองคลังซ้ำ') !== -1) {
          return msg + '\nกรุณาแก้ไขช่อง "เลขที่หนังสือ (AK)" หรือเว้นว่างไว้ก่อน';
        }
        if (
          msg.indexOf('missing_device_key') !== -1 ||
          msg.indexOf('กรุณาระบุ deviceKey') !== -1 ||
          msg.indexOf('not_logged_in') !== -1
        ) {
          return 'session หมดอายุ กรุณากลับไปหน้าแรกแล้วเข้าสู่ระบบใหม่';
        }
        return msg;
      }

      async function submitDoc() {
        showError('');
        var formData = buildFormData();
        var invalid = validateForm(formData);
        if (invalid) {
          Swal.fire({ icon: 'warning', title: invalid, confirmButtonColor: '#007AFF' });
          return;
        }

        setSaving(true);
        var nextId = '';
        var title = isEdit ? 'บันทึกการแก้ไขสำเร็จ' : 'เพิ่มเอกสารสำเร็จ';
        var saveErrorMessage = '';
        try {
          var res;
          if (isEdit) {
            res = await withTimeout(
              state.api.docUpdate(editId, formData, { noPageLoader: true }),
              45000,
              'บันทึกการแก้ไขใช้เวลานานเกินไป กรุณาลองใหม่'
            );
          } else {
            res = await withTimeout(
              state.api.docCreate(formData, { noPageLoader: true }),
              45000,
              'การเพิ่มเอกสารใช้เวลานานเกินไป กรุณาลองใหม่'
            );
          }

          if (!res || res.success === false) {
            throw new Error((res && res.error) ? res.error : 'ไม่สามารถบันทึกข้อมูลได้');
          }

          nextId = C.safeTrim((res && res.docId) || formData.amDocNo || formData.docNoSdh || editId || '');
        } catch (err) {
          saveErrorMessage = humanizeSaveErrorMessage((err && err.message) ? err.message : 'บันทึกไม่สำเร็จ');
        } finally {
          setSaving(false);
        }

        if (saveErrorMessage) {
          await Swal.fire('เกิดข้อผิดพลาด', saveErrorMessage, 'error');
          return;
        }

        await Swal.fire({
          icon: 'success',
          title: title,
          confirmButtonText: 'ดูรายละเอียดเอกสาร',
          confirmButtonColor: '#007AFF',
          allowOutsideClick: false
        });

        if (nextId) {
          C.redirect('document-view.html', { id: nextId }, true);
        } else {
          C.redirect('index.html', {}, true);
        }
      }

      async function initData() {
        var calls = [
          state.api.me(),
          state.api.optionsInfo(),
          state.api.call('docs.next_receive_nos', { deviceKey: state.settings.deviceKey })
        ];
        if (isEdit) calls.push(state.api.docDetail(editId));
        if (isCopy) calls.push(state.api.docDetail(copyFromId));

        var result = await Promise.all(calls);
        var meRes = result[0] || {};
        var infoRes = result[1] || {};
        var nextNosRes = result[2] || {};
        var docRes = (isEdit || isCopy) ? (result[3] || {}) : null;

        if (!meRes || meRes.success === false || !meRes.user) {
          C.redirect('index.html', {}, true);
          return false;
        }

        state.user = meRes.user;
        if (state.user.isReadOnly || state.user.canEdit === false) {
          C.redirect('access-denied.html', {
            message: 'บัญชีผู้มีสิทธิ์อ่าน ไม่สามารถเพิ่มหรือแก้ไขเอกสารได้'
          }, true);
          return false;
        }

        state.options = infoRes || { data: { fiscalYears: [], groups: [], purposes: [] } };
        state.nextNos = (nextNosRes && nextNosRes.data && typeof nextNosRes.data === 'object') ? nextNosRes.data : {};

        if (isEdit) {
          if (!docRes || docRes.success === false || !docRes.doc) {
            C.redirect('not-found.html', {
              message: 'ไม่พบเอกสาร',
              detail: editId,
              back: 'index.html'
            }, true);
            return false;
          }
          state.doc = docRes.doc;
        }

        if (isCopy) {
          if (!docRes || docRes.success === false || !docRes.doc) {
            C.redirect('not-found.html', {
              message: 'ไม่พบเอกสารต้นฉบับสำหรับคัดลอก',
              detail: copyFromId,
              back: 'index.html'
            }, true);
            return false;
          }
          state.copyDoc = docRes.doc;
        }

        return true;
      }

      function bindEvents() {
        els.btnBack.addEventListener('click', function () {
          if (isEdit && editId) {
            C.redirect('document-view.html', { id: editId });
          } else if (isCopy && copyFromId) {
            C.redirect('document-view.html', { id: copyFromId });
          } else {
            C.redirect('index.html');
          }
        });

        window.addEventListener('pageshow', function () {
          setSaving(false);
        });

        els.fiscalYear.addEventListener('change', updateReceiveNo);
        els.budgetType.addEventListener('change', togglePlanFields);
        els.btnSubmit.addEventListener('click', submitDoc);
      }

      function setupHeader() {
        if (isEdit) {
          els.pageIcon.className = 'bi bi-pencil-square';
          els.pageTitle.textContent = 'แก้ไขเอกสาร';
          els.pageSub.textContent = editId || '';
          els.btnSubmitText.textContent = 'บันทึกการแก้ไข';
          els.fiscalRow.style.display = 'none';
          els.receiveNoReadOnlyRow.style.display = 'block';
        } else if (isCopy) {
          els.pageIcon.className = 'bi bi-files';
          els.pageTitle.textContent = 'เพิ่มเอกสารจากสำเนา';
          els.pageSub.textContent = copyFromId ? ('คัดลอกจากเอกสาร: ' + copyFromId) : 'คัดลอกข้อมูลจากเอกสารเดิม';
          els.btnSubmitText.textContent = 'เพิ่มเอกสารชุดใหม่';
          els.fiscalRow.style.display = 'grid';
          els.receiveNoReadOnlyRow.style.display = 'none';
        } else {
          els.pageIcon.className = 'bi bi-plus-circle';
          els.pageTitle.textContent = 'เพิ่มเอกสารใหม่';
          els.pageSub.textContent = 'กรอกข้อมูลเพื่อบันทึกเอกสาร';
          els.btnSubmitText.textContent = 'เพิ่มเอกสาร';
          els.fiscalRow.style.display = 'grid';
          els.receiveNoReadOnlyRow.style.display = 'none';
        }
        updateBrowserTitle(isEdit ? editId : copyFromId);
      }

      function setDefaultDates() {
        if (isEdit) return;
        var now = new Date();
        var mm = String(now.getMonth() + 1).padStart(2, '0');
        var dd = String(now.getDate()).padStart(2, '0');
        var ymd = now.getFullYear() + '-' + mm + '-' + dd;
        els.dateRec.value = ymd;
        els.dated.value = ymd;
        refreshDateDisplays();
      }

      async function init() {
        if (isEdit && !editId) {
          C.redirect('not-found.html', {
            message: 'ไม่พบเอกสาร',
            detail: '',
            back: 'index.html'
          }, true);
          return;
        }

        try {
          state.settings = C.ensureSettingsOrThrow();
          state.api = C.createApiClient(state.settings);
        } catch (_e) {
          showError('กรุณาตั้งค่า scriptUrl และ deviceKey ที่หน้า index ก่อน');
          return;
        }

        fillTimeOptions();
        setupHeader();
        bindEvents();
        setSaving(false);

        try {
          var ok = await initData();
          if (!ok) return;

          fillOptions();

          if (isEdit && state.doc) {
            setFormData(state.doc);
          } else {
            updateReceiveNo();
            setDefaultDates();
            if (isCopy && state.copyDoc) {
              setCopyFormData(state.copyDoc);
            }
          }

          togglePlanFields();
          refreshDateDisplays();
          els.mainCard.style.display = 'block';
        } catch (err) {
          showError((err && err.message) ? err.message : 'โหลดข้อมูลฟอร์มไม่สำเร็จ');
        }
      }

      init();
    })();
  </script>
</body>
</html>
